---
title: "STAT 331 Final Project"
author: "Adam Manzke, Rianna Lei, Addie Lilley, Hannah Goudz" 
format:
  html:
    embed-resources: true
    code-tools: true
    code-fold: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---


# Introduction

The focus of our project is to research whether there is an association between inequality index and happiness score. We're interested in these variables because we were fascinated by the premise of quantifying happiness, and we'd like to find out if wealth inequality is related.

## Data and Variables

### Data Sources

- **Variable 1**: *Inequality Index* — [downloaded from Gapminder](https://data.worldbank.org/indicator/SI.POV.GINI)
- **Variable 2**: *Happiness Score* — [downloaded from Gapminder](http://gapm.io/dhapiscore_whr)

The Inequality Index is originally sourced from World Bank. The happiness score data also originates from World Bank, but Gapminder does not provide a link to it.


### Variables

- **Inequality Index**: The percent of inequality (percent deviation from the "ideal line", where every person in society has the same income). This is called the Gini Index. You can read more about this [here](https://en.wikipedia.org/wiki/Lorenz_curve).

- **Happiness Score**: A measurement from 0 to 100, where subjects were asked to rank their current life satisfaction, where 0 is the worst possible life for the subject and 100 is the best based on the Cantril life ladder from the Gapminder data. The happiness score is based on an the weighted average score using the country's population as weights.

## Hypothesis

> We hypothesize that there is a strong negative relationship between happiness score and inequality index. A study discussed in a Forbes article (Jennings 2024) showed that happiness increases with wealth (up to a point), so in countries with more wealth inequality, more people will rate their happiness lower.

# Data Cleaning Process

To prepare the data for analysis, we reshaped both data sets so that each row represents one country in a given year. We then joined the two sources by matching by the country and year. Since happiness data only begins in 2005, we limited our analysis to the years 2005 through 2023. After joining the data, we excluded any rows where either the inequality index or the happiness score was missing.

After removing missing values, the cleaned data set included 134 countries with complete observations. We noted that most missing values occurred in earlier years and were more common among lower-income or smaller countries. This could introduce some bias if countries with less reliable reporting are systematically different.

```{r}
#| message: false
library(tidyverse)
library(knitr)
library(kableExtra)
library(broom)
# Read data
ineq <- read_csv("inequality_index_gini.csv")
happ <- read_csv("hapiscore_whr.csv")
```

```{r}
# Pivot longer
ineq_long <- ineq |> 
  pivot_longer(cols = -country,
               names_to = "year",
               values_to = "inequality_score") |> 
  mutate(year = as.integer(year))

happ_long <- happ |> 
  pivot_longer(cols = -country,
               names_to = "year",
               values_to = "happ_score") |> 
  mutate(year = as.integer(year))

# Join datasets - happiness starts at 2004 whereas ineq starts at 1963,
# so only keep observations from 2005 onward
gapminder_clean <- left_join(happ_long, ineq_long, by = c("country", "year"))

# Optional: drop rows with missing data
gapminder_clean <- gapminder_clean |> 
  drop_na()

```

## Summary

The cleaned dataset includes 134 countries and spans the years 2005 to 2023. Each row represents a country-year observation and includes values for both happpiness score and inequality index. When removing missing values, it removed 1,978 missing observations, leaving us with 1,138 total observations in our cleaned data set.

---

# Modeling the Relationship between Inequality Index and Happiness Score

Linear regression is a statistical technique used to analyze the relationship between a dependent variable and the independent variable. Using a simple linear regression, we are testing whether there is a relationship between the average happiness score and inequality index. 

## Data Visualization

```{r}
gapminder_average <- gapminder_clean |> 
  group_by(country) |> 
  summarise(avg_happ = mean(happ_score),
         avg_ineq = mean(inequality_score))

gapminder_average |> 
  ggplot(aes(x = avg_ineq, y = avg_happ)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  labs(x = "Average Inequality Index",
       y = "Average Happiness Score",
       title = "Average Inequality Index vs. Average Happiness Score",
       subtitle = "For each country, over all years (2005 - 2023)")
```

The scatterplot above shows the relationship between average inequality index and average happiness score for each country. The downward trend indicates a slight negative relationship between the two variables.

```{r}
library(gganimate)
library(gifski)

gapminder_anim <- gapminder_clean |> 
  ggplot(aes(x = inequality_score, y = happ_score)) +
  geom_jitter() +
  labs(x = "Inequality Index",
       y = "Happiness Score",
       subtitle = "{frame_time}",
       title = "Inequality Index vs. Happiness Score") +
  theme(plot.subtitle = element_text(color = "steelblue", size = 14),
        plot.title = element_text(hjust = 0.5)) +
  transition_time(year) +
  ease_aes("linear")

animate(gapminder_anim, nframes = 19, fps = 1)
```

The animated plot above shows how the relationship between inequality and happiness changes over time from 2005 to 2023. While variability exists year-to-year, the overall negative trend persists throughout the time period.

## Apply Linear Regression

To investigate the relationship between inequality and happiness, we computed the average inequality index and average happiness score for each country over the period 2005 to 2023. These average values are reflected in the scatterplot in the previous section. We used these values to build a simple linear regression model, with happiness as the response variable and inequality as the explanatory variable.

```{r}
gapminder_average_lm <- lm(avg_happ ~ avg_ineq,
                           data = gapminder_average)
```

```{r}
#| eval: false

gapminder_average_lm |> 
  tidy()
```

The model is
\begin{align}
\widehat{happiness} & = 67.630-0.357\times inequality.
\end{align}

This equation suggests that for every one-point increase in the inequality index, a country’s average happiness score decreases by approximately 0.357 points. This negative association supports our hypothesis that countries with higher income inequality tend to report lower levels of happiness.

## Model Fit

The table below summarizes the variance in the observed happiness scores, the fitted values from the regression model, and the model residuals. The $R^2$ value indicates that only a small proportion of the total variance is explained by inequality.

```{r}
augment(gapminder_average_lm) |> 
  mutate(var_fitted = var(.fitted),
         var_resp = var(avg_happ),
         var_resid = var(.resid),
         r_square = var_fitted / var_resp) |> 
  select(var_resp, var_fitted, var_resid, r_square) |> 
  distinct() |> 
  kable(digits = c(2, 2, 2, 4),
        col.names = c("Response Values", "Fitted Values", "Residuals", "R-squared"),
        caption = "Model Fit") |> 
  kable_styling(full_width = FALSE, bootstrap_options = "striped") |> 
  add_header_above(c("Variance in" = 3, " " =  1),
                   bold = TRUE) |> 
  row_spec(row = 0, bold = T, align = "c")
```


We evaluated the model's performance by examining how much of the variation in happiness scores it was able to explain. The total variance in happiness scores across countries was approximately 115.76, while the variance explained by the regression model was about 6.67. This leaves roughly 109.09 units of unexplained variance, resulting in an $R^2$ value of 0.0576.

This means that only 5.76% of the variation in average happiness scores can be explained by differences in income inequality. While the relationship is negative, as expected, the small $R^2$ value suggests that inequality alone is not a strong predictor of happiness. Other factors; such as health, education, political stability, and social support, are likely more influential and should be considered in future models.

---

# Cross Validation

$k$-fold cross-validation expands the test/train idea for model validation by using all of the observations for validation, rather than just one subset. It works by randomly subsetting the observations into $k$ folds, training the model on $k-1$ folds, and testing on the remaining fold. This process is repeated for all folds, meaning the model is fit and tested $k$ times. The final performance measure of the model is the average of the $k$ performance measures. Here, our performance measure is the $R^2$ statistic.

## Implement k-fold cross validation

Since we have 134 observations in our data set and we want at least 10 samples per fold, we have a practical upper limit of 13 folds. To make things simpler, we will set $k=10$.

We start by randomly subsetting the data into 10 folds, giving each observation a number between one and ten. For each iteration, we separate the data into a training set and a test set, and fit the model to the training set. We generate predicted values from the test set, and record the $R^2$ in a vector.

```{r}
k <- 10
n <- 134
set.seed(679)

# from 10.1 lecture slides
gapminder_average <- gapminder_average |> 
  mutate(fold_random = sample(rep_len(1:k, length.out = n),
                              size = n))

fold_lm <- function(fold_number, data){
  stopifnot(k >= 1 & k <= 10)
  
  train_dat <- data |> 
    filter(fold_random != fold_number)
  test_dat <- data |> 
    filter(fold_random == fold_number)
  

  model <- lm(avg_happ ~ avg_ineq, data = train_dat)
  
  return(var(predict(model, newdata = test_dat)) / var(test_dat$avg_happ))
  
}

r_sq <- map_dbl(.x = 1:10, .f = ~ fold_lm(.x, gapminder_average))

```

## Plot the Results

The plot below shows the distribution of the cross-validated $R^2$ values across 10 folds. We also include a dashed red line indicating the mean $R^2$ value to help assess overall model performance.

```{r}
tibble(r_sq) |> 
  ggplot(aes(x = r_sq)) +
  geom_histogram(bins = 10, fill = "steelblue", color = "white") +
  geom_vline(aes(xintercept = mean(r_sq)), color = "red", linetype = "dashed") +
  labs(title = "Distribution of Cross-Validated R² Values",
       x = "R²",
       y = "Count",
       subtitle = paste("Mean R² =", round(mean(r_sq), 3))) +
  theme_minimal()
```


The distribution of $R^2$ values across folds is relatively tight, with most values clustering near 0.02. This consistency suggests that the model's performance is stable, although weak in explanatory power. The low mean $R^2$ confirms that inequality alone is not a strong predictor of happiness, supporting our earlier interpretation of the linear regression model. Furthermore, the original $R^2$ found from the full data set (0.0576) is fairly close to the average $R^2$ found from the cross-validation, so we have no strong evidence of overfitting.

---

# Conclusion

This project explored the relationship between income inequality and national happiness levels using data from Gapminder. We hypothesized that higher inequality would correspond with lower happiness. Our regression model supported this hypothesis directionally but revealed a weak relationship, with inequality explaining only about 5% of the variation in happiness scores. 

Cross-validation confirmed the model’s consistency, with a low but stable $R^2$ across all folds. This suggests that while inequality may play a role, it is not a strong standalone predictor of happiness. Other factors—such as health care, education, governance, or social support—likely play a larger role and would be valuable to include in future models.

Overall, this analysis demonstrates the importance of multivariable modeling in understanding complex social phenomena.

---

## Citations

*GINI Index.* Gapminder. https://data.worldbank.org/indicator/SI.POV.GINI

*WHR Happiness Score.* Gapminder. http://gapm.io/dhapiscore_whr

Jennings, J. (2024, June 3). *More money increases happiness beyond $75,000.* Forbes. https://www.forbes.com/sites/johnjennings/2024/02/12/money-buys-happiness-after-all/

